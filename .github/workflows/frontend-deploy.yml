name: Deploy Frontend to cPanel

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy-frontend:
    name: Deploy Frontend (Nuxt)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Install Frontend Dependencies
        run: bun install

      - name: Build Nuxt Application
        run: bun run build
        env:
          NODE_ENV: production
          NUXT_PUBLIC_API_BASE: ${{ secrets.NUXT_API_BASE }}
          NUXT_PUBLIC_API_URL: ${{ secrets.NUXT_API_BASE }}
          NUXT_PUBLIC_SITE_URL: ${{ secrets.NUXT_SITE_URL }}
          NUXT_PUBLIC_APP_NAME: Marathon Indonesia

      - name: Prepare Deployment Files
        run: |
          # Copy package.json from server to root for cPanel
          cp .output/server/package.json .output/package.json || true
          
          # Copy .npmrc from root to .output (or create if not exists)
          if [ -f .npmrc ]; then
            cp .npmrc .output/.npmrc
            echo "‚úÖ Copied .npmrc from repository"
          else
            # Create .npmrc if not in repository
            cat > .output/.npmrc << 'EOF'
          shamefully-hoist=true
          optional=false
          EOF
            echo "‚úÖ Created .npmrc (skips optional deps like sharp)"
          fi
          
          # Copy public files to .output (if any)
          cp -r public/* .output/public/ 2>/dev/null || true
          
          # Verify package.json exists
          test -f .output/package.json && echo "‚úÖ package.json ready" || echo "‚ö†Ô∏è  package.json not found"

      - name: Deploy Frontend to cPanel
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.CPANEL_FTP_HOST }}
          username: ${{ secrets.FRONTEND_FTP_USER }}
          password: ${{ secrets.FRONTEND_FTP_PASS }}
          local-dir: .output/
          server-dir: /
          protocol: ftp
          port: 21
          exclude: |
            **/.git*
            **/.cursor/**
            **/.vscode/**
            **/node_modules/**
            .env*
            # Note: .npmrc and package.json will be uploaded (needed for npm install on server)

      - name: Post-Deployment Notice
        run: |
          echo "‚úÖ Frontend deployment to cPanel completed successfully!"
          echo ""
          echo "‚ö†Ô∏è  IMPORTANT: node_modules excluded from deploy. Install dependencies on server:"
          echo ""
          echo "   Run these commands via cPanel Terminal:"
          echo "   cd /home/youruser/yourdomain.com"
          echo "   npm install --production"
          echo ""
          echo "   ‚ö†Ô∏è  If Sharp platform mismatch error occurs:"
          echo "      npm run postinstall:sharp"
          echo "      # OR manually:"
          echo "      npm rebuild sharp --arch=x64 --platform=linux"
          echo ""
          echo "   Then restart your application:"
          echo "      pm2 restart marathon-frontend"
          echo ""
          echo "   üìù .npmrc Configuration:"
          echo "      - shamefully-hoist=true (for cPanel compatibility)"
          echo "      - optional=false (skips optional deps)"
          echo ""
          echo "   ‚ÑπÔ∏è  Note: IPX provider requires Sharp. If install fails,"
          echo "      rebuild Sharp with correct platform (see above)."
