name: Deploy Frontend to cPanel

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy-frontend:
    name: Deploy Frontend (Nuxt)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Install Frontend Dependencies
        run: bun install

      - name: Build Nuxt Application
        run: bun run build
        env:
          NODE_ENV: production
          NUXT_PUBLIC_API_BASE: ${{ secrets.NUXT_API_BASE }}
          NUXT_PUBLIC_API_URL: ${{ secrets.NUXT_API_BASE }}
          NUXT_PUBLIC_SITE_URL: ${{ secrets.NUXT_SITE_URL }}
          NUXT_PUBLIC_APP_NAME: Marathon Indonesia

      - name: Prepare Deployment Files
        run: |
          # Copy package.json from server to root for cPanel
          cp .output/server/package.json .output/package.json || true
          
          # Create .npmrc for cPanel compatibility (shamefully-hoist untuk resolve dependencies)
          echo "shamefully-hoist=true" > .output/.npmrc
          echo "✅ Created .npmrc with shamefully-hoist=true"
          
          # Copy public files to .output (if any)
          cp -r public/* .output/public/ 2>/dev/null || true
          
          # Verify package.json exists
          test -f .output/package.json && echo "✅ package.json ready" || echo "⚠️  package.json not found"

      - name: Deploy Frontend to cPanel
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.CPANEL_FTP_HOST }}
          username: ${{ secrets.FRONTEND_FTP_USER }}
          password: ${{ secrets.FRONTEND_FTP_PASS }}
          local-dir: .output/
          server-dir: /
          protocol: ftp
          port: 21
          exclude: |
            **/.git*
            **/.cursor/**
            **/.vscode/**
            **/node_modules/**
            .env*
            # Note: .npmrc and package.json will be uploaded (needed for npm install on server)

      - name: Post-Deployment Notice
        run: |
          echo "✅ Frontend deployment to cPanel completed successfully!"
          echo ""
          echo "⚠️  IMPORTANT: node_modules excluded from deploy. Install dependencies on server:"
          echo ""
          echo "   Run these commands via cPanel Terminal:"
          echo "   cd /home/youruser/yourdomain.com"
          echo "   npm install --production"
          echo "   pm2 restart marathon-frontend"
          echo ""
          echo "   .npmrc with 'shamefully-hoist=true' has been uploaded for cPanel compatibility."
