name: Deploy Frontend to cPanel

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy-frontend:
    name: Deploy Frontend (Nuxt)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Install Frontend Dependencies
        run: bun install

      - name: Build Nuxt Application
        run: bun run build
        env:
          NODE_ENV: production
          NUXT_PUBLIC_API_BASE: ${{ secrets.NUXT_API_BASE }}
          NUXT_PUBLIC_API_URL: ${{ secrets.NUXT_API_BASE }}
          NUXT_PUBLIC_SITE_URL: ${{ secrets.NUXT_SITE_URL }}
          NUXT_PUBLIC_APP_NAME: Marathon Indonesia

      - name: Prepare Deployment Files
        run: |
          # Copy public files to .output (if any)
          cp -r public/* .output/public/ 2>/dev/null || true
          
          # Verify server build is self-contained
          echo "üîç Verifying Nitro build..."
          test -f .output/server/index.mjs && echo "‚úÖ Server entry point exists" || echo "‚ùå Server entry point missing!"
          test -d .output/server/node_modules && echo "‚ö†Ô∏è  node_modules found (should be bundled)" || echo "‚úÖ No node_modules (dependencies bundled)"
          
          # Check if lru-cache is bundled (should be in chunks)
          if grep -r "lru-cache" .output/server/chunks/ > /dev/null 2>&1; then
            echo "‚úÖ lru-cache is bundled in chunks"
          else
            echo "‚ö†Ô∏è  lru-cache not found in chunks (may cause runtime error)"
          fi
          
          echo "‚úÖ Deployment files ready (self-contained build)"

      - name: Deploy Frontend to cPanel
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.CPANEL_FTP_HOST }}
          username: ${{ secrets.FRONTEND_FTP_USER }}
          password: ${{ secrets.FRONTEND_FTP_PASS }}
          local-dir: .output/
          server-dir: /
          protocol: ftp
          port: 21
          exclude: |
            **/.git*
            **/.cursor/**
            **/.vscode/**
            **/node_modules/**
            .env*
            # Note: Build is self-contained, no npm install needed on server

      - name: Post-Deployment Notice
        run: |
          echo "‚úÖ Frontend deployment to cPanel completed successfully!"
          echo ""
          echo "üì¶ Build is self-contained (all dependencies bundled by Nitro)"
          echo ""
          echo "üöÄ Next steps:"
          echo "   1. Restart your Node.js application (PM2/supervisor)"
          echo "   2. Verify the app is running: node server/index.mjs"
          echo ""
          echo "üí° No npm install needed - all dependencies are bundled in .output/server/"
